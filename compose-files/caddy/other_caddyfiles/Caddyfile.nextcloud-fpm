cloud.cequent.nl {
        encode zstd gzip

	# Root web directory is the nextcloud volume from the Nextcloud Compose, needed for serving static files (e.g. .css .js .pngs) for the Nextcloud web client
        root * /var/www/nextcloud

        # Rules here are all from .htaccess
        redir /.well-known/carddav /remote.php/dav 301
        redir /.well-known/caldav /remote.php/dav 301
        redir /.well-known/* /index.php{uri} 301 # Nextcloud front-controller handles routes to /.well-known
        redir /remote/* /remote.php{uri} 301

        # Secure headers, all from .htaccess except Permissions-Policy, STS and X-Powered-By
        header {
                Strict-Transport-Security max-age=31536000
                Permissions-Policy interest-cohort=()
                X-Content-Type-Options nosniff
                X-Frame-Options SAMEORIGIN
                Referrer-Policy no-referrer
                X-XSS-Protection "1; mode=block"
                X-Permitted-Cross-Domain-Policies none
                X-Robots-Tag "noindex, nofollow"
                -X-Powered-By
        }

        # Uncomment this block if you use the high speed files backend: https://github.com/nextcloud/notify_push
        #handle_path /push/* {
        #       reverse_proxy unix//run/notify_push/notify_push.sock # I love Unix sockets, but you can do :7867 also
        #}

        # Uncomment this block if you use onlyoffice: https://github.com/nextcloud/all-in-one/blob/main/Containers/apache/Caddyfile
        #handle_path /onlyoffice/* {
        #       reverse_proxy {$ONLYOFFICE_IP}:{$ONLYOFFICE_PORT} {
        #               header_up X-Forwarded-Host {host}/onlyoffice
        #       }
        #}

        # PHP block
        php_fastcgi nextcloud:9000 {
                root /var/www/html # the webroot for the nextcloud fpm container is /var/www/html
                env front_controller_active true # Enable pretty urls
                env modHeadersAvailable true # Avoid sending the security headers twice
        }

        # From .htaccess, deny access to sensible files and directories
        @forbidden {
                path /build/* /tests/* /config/* /lib/* /3rdparty/* /templates/* /data/*
                path /.* /autotest* /occ* /issue* /indie* /db_* /console*
                not path /.well-known/*
        }
        error @forbidden 404

        # From .htaccess, set cache for versioned static files (cache-busting)
        @immutable {
                path *.css *.js *.mjs *.svg *.gif *.png *.jpg *.ico *.wasm *.tflite
                query v=*
        }
        header @immutable Cache-Control "max-age=15778463, immutable"

        # From .htaccess, set cache for normal static files
        @static {
                path *.css *.js *.mjs *.svg *.gif *.png *.jpg *.ico *.wasm *.tflite
                not query v=*
        }
        header @static Cache-Control "max-age=15778463"

        # From .htaccess, cache fonts for 1 week
        @woff2 path *.woff2
        header @woff2 Cache-Control "max-age=604800"

        file_server
}
